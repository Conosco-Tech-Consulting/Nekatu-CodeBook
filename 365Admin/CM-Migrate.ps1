if ( (Get-PSSnapin -Name Metalogix.System.Commands -ErrorAction SilentlyContinue) -eq $null ) { add-pssnapin Metalogix.System.Commands | out-null }
if ( (Get-PSSnapin -Name Metalogix.File.Commands -ErrorAction SilentlyContinue) -eq $null ) { add-pssnapin Metalogix.File.Commands | out-null }

# Set default resolvers
Set-MetalogixDefaultResolverSetting -Name "NodeLocation" -Value "Metalogix.Explorer.PersistentConnectionsResolver, Metalogix.Explorer, Version=8.2.0.2, Culture=neutral, PublicKeyToken=3b240fac3e39fc03"
Set-MetalogixDefaultResolverSetting -Name "ResourceTableResourceTableLink" -Value "Metalogix.ResourceFileTableResolver, Metalogix.Core, Version=8.2.0.2, Culture=neutral, PublicKeyToken=3b240fac3e39fc03"
Set-MetalogixDefaultResolverSetting -Name "DataResolverDataRepositoryLink" -Value "Metalogix.Client.ClientDataRepositoryResolver, Metalogix.Client, Version=8.2.0.2, Culture=neutral, PublicKeyToken=3b240fac3e39fc03"

# Load configuration settings
Load-MetalogixConfigurationVariableSettings -FilePath "C:\Users\arikf\AppData\Roaming\Metalogix\UserSettings.xml" -Scope UserSpecific
Load-MetalogixConfigurationVariableSettings -FilePath "C:\Users\arikf\AppData\Roaming\Metalogix\Content Matrix Console - File Share Edition\ApplicationSettings.xml" -Scope ApplicationAndUserSpecific
Load-MetalogixConfigurationVariableSettings -FilePath "C:\ProgramData\Metalogix\EnvironmentSettings.xml" -Scope EnvironmentSpecific

# Load source
$SourceCollection = New-MetalogixSerializableObjectCollection "<IXMLAbleList IXMLAbleType=`"Metalogix.Explorer.NodeCollection, Metalogix.Explorer, Version=8.2.0.2, Culture=neutral, PublicKeyToken=3b240fac3e39fc03`"><NodeCollection><Location Path=`"/UserData/Staff/sdinning/Documents`" DisplayUrl=`"\\tpt-svr-file1\e`$\UserData\Staff\sdinning\Documents`"><Connection NodeType=`"Metalogix.File.FileConnection, Metalogix.File, Version=8.2.0.2, Culture=neutral, PublicKeyToken=3b240fac3e39fc03`" Path=`"\\tpt-svr-file1\e`$`" MetabaseType=`"SqlCe`" MetabaseContext=`"AQAAANCMnd8BFdERjHoAwE/Cl+sBAAAAmV3bG5KknUOpvDbMCbO2pwAAAAACAAAAAAADZgAAwAAAABAAAAAh3OHfEiCZtZFzLHyHI7eNAAAAAASAAACgAAAAEAAAAOYrWKXUL0bYjoVeyRTXh3kAAQAA1rxsYeFiXFxlVQ5LAIPR39ZkgKHNOdaDC+7WUsEgmWaU88Lvn/W5qyCBzIXgwvFF7Qa/2SiuymfuGKtdOwami/AU0c5CZJfs7sCiZZ6cSC5z5OmC5EIbRL8DVAu8uX2tjFYigYeoQSA+zjXIE9fhryTR/kkSHrf+5+/PpYQ8A0Ohu6hEegPjQ7RlGidOFN05WVTIDSeNjG378nitKlP4ISISpS5Oj9wCTLaoK5SxnD9kNBtmY/apB9rDWVEb/lqE86CvN5oT9lxVpb8fkUEwJwYmiJzqaaeEtfYQ4hK6qhmjzOjH7DkNJ0ZCFZ3Jg8klmN7a69V62FkzGBZsZ9BiVRQAAAD4dqKPGBbF+08e9PUOEBdHaGJ6fQ==`" /></Location></NodeCollection></IXMLAbleList>"

# Load target
$TargetCollection = New-MetalogixSerializableObjectCollection "<IXMLAbleList IXMLAbleType=`"Metalogix.Explorer.NodeCollection, Metalogix.Explorer, Version=8.2.0.2, Culture=neutral, PublicKeyToken=3b240fac3e39fc03`"><NodeCollection><Location Path=`"/https:%2F%2Ffossewayschool-my.sharepoint.com%2Fpersonal%2Fsdinning_thepartnershiptrust_com`" DisplayUrl=`"https://fossewayschool-my.sharepoint.com/personal/sdinning_thepartnershiptrust_com`"><Connection NodeType=`"Metalogix.SharePoint.SPTenantMySiteHost, Metalogix.SharePoint, Version=8.2.0.2, Culture=neutral, PublicKeyToken=3b240fac3e39fc03`" SharePointVersion=`"2147483647.0.0.0`" UnderlyingAdapterType=`"CSOM`" ShowAllSites=`"True`" AdapterType=`"CSOM`" Url=`"https://fossewayschool-admin.sharepoint.com`" UserName=`"joskos@fossewayschool.com`" SavePassword=`"True`" Password=`"AQAAANCMnd8BFdERjHoAwE/Cl+sBAAAAmV3bG5KknUOpvDbMCbO2pwAAAAACAAAAAAADZgAAwAAAABAAAACZ62SpB1yGSDawsHdGL+XJAAAAAASAAACgAAAAEAAAAAcq58wr2xjgkkodZ+qA0AUYAAAAfOuYrT5qDAGlPaCgHVC5+JHszk9HCb81FAAAAHEbNbYzButsEx9x/QJM77WO60N6`" ReadOnly=`"False`" AuthenticationType=`"Metalogix.SharePoint.Adapters.Authentication.Office365StandADFSInitializer`" /></Location></NodeCollection></IXMLAbleList>"

# Run the action
foreach($Target in $TargetCollection) {
    $SourceCollection | Copy-FolderAsList -Target $Target  -IncludeSubFolders -ExistingFolderAction "UseExisting" -FileSettings ( New-MetalogixSerializableObject "Metalogix.File.Actions.PasteFileOptions" "Metalogix.File" "<ActionOptions Type=`"Metalogix.File.Actions.PasteFileOptions, Metalogix.File, Version=8.2.0.2, Culture=neutral, PublicKeyToken=3b240fac3e39fc03`"><IncludeFiles Type=`"System.Boolean`">True</IncludeFiles><RenameFiles Type=`"System.Boolean`">False</RenameFiles><RenameColumn Type=`"System.String`">SourceURL</RenameColumn><MigrateAsDefaultContentType Type=`"System.Boolean`">True</MigrateAsDefaultContentType><ExistingFileAction Type=`"Metalogix.File.Actions.ExistingItemAction`">Overwrite</ExistingFileAction><TargetContentTypeID Type=`"System.String`">0x0101</TargetContentTypeID><ContentTypeFieldMappings Type=`"Metalogix.File.Actions.ContentTypeFieldMappings`"><XmlableSet><XmlableItem Type=`"Metalogix.Data.Mapping.ListSummaryItem, Metalogix.Explorer, Version=8.2.0.2, Culture=neutral, PublicKeyToken=3b240fac3e39fc03`"><ListSummaryItem Group=`"`"><CustomColumns><XmlableTable /></CustomColumns><Source><ListPickerItem Group=`"`" Target=`"Url`" TargetType=`"`"><CustomColumns><XmlableTable /></CustomColumns><Tag IsNew=`"False`" Type=`"Metalogix.Explorer.NodePropertyDescriptor, Metalogix.Explorer, Version=8.2.0.2, Culture=neutral, PublicKeyToken=3b240fac3e39fc03`" /></ListPickerItem></Source><Target><ListPickerItem Group=`"`" Target=`"MigrationSourceURL`" TargetType=`"Note`"><CustomColumns><XmlableTable /></CustomColumns><Tag IsNew=`"False`" Type=`"Metalogix.SharePoint.SPField, Metalogix.SharePoint, Version=8.2.0.2, Culture=neutral, PublicKeyToken=3b240fac3e39fc03`"><Field Name=`"MigrationSourceURL`" DisplayName=`"MigrationSourceURL`" Type=`"Note`" ID=`"{076b750d-cd5c-48e8-9983-6267be1e67d8}`" SourceID=`"{fbcada76-c4b8-4ae3-8e1d-83e49f2ba532}`" StaticName=`"MigrationSourceURL`" ColName=`"ntext2`" RowOrdinal=`"0`" Version=`"1`" /></Tag></ListPickerItem></Target></ListSummaryItem></XmlableItem></XmlableSet></ContentTypeFieldMappings><PermissionsOptions Type=`"Metalogix.File.Actions.EditPermissionsOptions`"><EditPermissionsOptions MapUsers=`"False`" PermissionsMode=`"Skip`"><Permissions><XmlableSet /></Permissions></EditPermissionsOptions></PermissionsOptions><LinkCorrectionOptions Type=`"Metalogix.File.Actions.LinkCorrection.LinkCorrectionOptions`"><MigrateSourceUrl Type=`"System.Boolean`">True</MigrateSourceUrl><SourceUrlProperty Type=`"System.String`">MigrationSourceURL</SourceUrlProperty><EmailServer Type=`"System.String`" /><EmailUserName Type=`"System.String`" /><EmailPassword Type=`"System.String`" /><ToEmailAddress Type=`"System.String`" /><FromEmailAddress Type=`"System.String`" /><CCEmailAddress Type=`"System.String`" /><BCCEmailAddress Type=`"System.String`" /><EmailSuccessTemplateFilePath Type=`"System.String`" /><EmailFailureTemplateFilePath Type=`"System.String`" /><EmailSubject Type=`"System.String`" /><SendEmail Type=`"System.Boolean`">False</SendEmail><Transformers Type=`"Metalogix.Transformers.TransformerCollection`"><TransformerCollection /></Transformers><LinkCorrectionOptions MigrateSourceUrl=`"True`" SourceUrlProperty=`"MigrationSourceURL`" /></LinkCorrectionOptions><StoragePointOptions Type=`"Metalogix.SharePoint.Options.Migration.StoragePointOptions`"><SideLoadDocuments Type=`"System.Boolean`">True</SideLoadDocuments><EmailServer Type=`"System.String`" /><EmailUserName Type=`"System.String`" /><EmailPassword Type=`"System.String`" /><ToEmailAddress Type=`"System.String`" /><FromEmailAddress Type=`"System.String`" /><CCEmailAddress Type=`"System.String`" /><BCCEmailAddress Type=`"System.String`" /><EmailSuccessTemplateFilePath Type=`"System.String`" /><EmailFailureTemplateFilePath Type=`"System.String`" /><EmailSubject Type=`"System.String`" /><SendEmail Type=`"System.Boolean`">False</SendEmail><Transformers Type=`"Metalogix.Transformers.TransformerCollection`"><TransformerCollection /></Transformers></StoragePointOptions><ReplaceInvalidCharacter Type=`"System.Boolean`">True</ReplaceInvalidCharacter><ReplaceCharacter Type=`"System.Char`">_</ReplaceCharacter><TargetHierarchyOptions Type=`"Metalogix.File.Actions.PasteHierarchyOptions`"><MigrateToDocSet Type=`"System.Boolean`">False</MigrateToDocSet><FlattenFolderHierarchyAndConvertToDocSet Type=`"System.Boolean`">False</FlattenFolderHierarchyAndConvertToDocSet><PermissionsOptions Type=`"Metalogix.File.Actions.EditPermissionsOptions`"><EditPermissionsOptions MapUsers=`"False`" PermissionsMode=`"Skip`"><Permissions><XmlableSet /></Permissions></EditPermissionsOptions></PermissionsOptions><TargetDocSetOptions Type=`"Metalogix.File.Actions.TargetLocationOptions`"><PathSource Type=`"Metalogix.File.Actions.TargetLocationOptions+LocationProvider`">NoFolderStructure</PathSource><SourceStructureLocation Type=`"Metalogix.File.Actions.TargetLocationOptions+StructureLocation`">Leaf</SourceStructureLocation><ColumnName Type=`"System.String`" /><TextValue Type=`"System.String`" /><EmailServer Type=`"System.String`" /><EmailUserName Type=`"System.String`" /><EmailPassword Type=`"System.String`" /><ToEmailAddress Type=`"System.String`" /><FromEmailAddress Type=`"System.String`" /><CCEmailAddress Type=`"System.String`" /><BCCEmailAddress Type=`"System.String`" /><EmailSuccessTemplateFilePath Type=`"System.String`" /><EmailFailureTemplateFilePath Type=`"System.String`" /><EmailSubject Type=`"System.String`" /><SendEmail Type=`"System.Boolean`">False</SendEmail><Transformers Type=`"Metalogix.Transformers.TransformerCollection`"><TransformerCollection /></Transformers></TargetDocSetOptions><MigrateToSubFolder Type=`"System.Boolean`">True</MigrateToSubFolder><TargetSubFolderOptions Type=`"Metalogix.File.Actions.TargetLocationOptions`"><PathSource Type=`"Metalogix.File.Actions.TargetLocationOptions+LocationProvider`">SourceStructure</PathSource><SourceStructureLocation Type=`"Metalogix.File.Actions.TargetLocationOptions+StructureLocation`">Leaf</SourceStructureLocation><ColumnName Type=`"System.String`" /><TextValue Type=`"System.String`" /><EmailServer Type=`"System.String`" /><EmailUserName Type=`"System.String`" /><EmailPassword Type=`"System.String`" /><ToEmailAddress Type=`"System.String`" /><FromEmailAddress Type=`"System.String`" /><CCEmailAddress Type=`"System.String`" /><BCCEmailAddress Type=`"System.String`" /><EmailSuccessTemplateFilePath Type=`"System.String`" /><EmailFailureTemplateFilePath Type=`"System.String`" /><EmailSubject Type=`"System.String`" /><SendEmail Type=`"System.Boolean`">False</SendEmail><Transformers Type=`"Metalogix.Transformers.TransformerCollection`"><TransformerCollection /></Transformers></TargetSubFolderOptions><MigratePermissionsForSubFolder Type=`"System.Boolean`">False</MigratePermissionsForSubFolder><TargetDocLibOptions Type=`"Metalogix.File.Actions.TargetLocationOptions`"><PathSource Type=`"Metalogix.File.Actions.TargetLocationOptions+LocationProvider`">SourceStructure</PathSource><SourceStructureLocation Type=`"Metalogix.File.Actions.TargetLocationOptions+StructureLocation`">Root</SourceStructureLocation><ColumnName Type=`"System.String`" /><TextValue Type=`"System.String`" /><EmailServer Type=`"System.String`" /><EmailUserName Type=`"System.String`" /><EmailPassword Type=`"System.String`" /><ToEmailAddress Type=`"System.String`" /><FromEmailAddress Type=`"System.String`" /><CCEmailAddress Type=`"System.String`" /><BCCEmailAddress Type=`"System.String`" /><EmailSuccessTemplateFilePath Type=`"System.String`" /><EmailFailureTemplateFilePath Type=`"System.String`" /><EmailSubject Type=`"System.String`" /><SendEmail Type=`"System.Boolean`">False</SendEmail><Transformers Type=`"Metalogix.Transformers.TransformerCollection`"><TransformerCollection /></Transformers></TargetDocLibOptions><MigrateToSubSite Type=`"System.Boolean`">False</MigrateToSubSite><TargetSubSiteOptions Type=`"Metalogix.File.Actions.TargetLocationOptions`"><PathSource Type=`"Metalogix.File.Actions.TargetLocationOptions+LocationProvider`">SourceStructure</PathSource><SourceStructureLocation Type=`"Metalogix.File.Actions.TargetLocationOptions+StructureLocation`">Leaf</SourceStructureLocation><ColumnName Type=`"System.String`" /><TextValue Type=`"System.String`" /><EmailServer Type=`"System.String`" /><EmailUserName Type=`"System.String`" /><EmailPassword Type=`"System.String`" /><ToEmailAddress Type=`"System.String`" /><FromEmailAddress Type=`"System.String`" /><CCEmailAddress Type=`"System.String`" /><BCCEmailAddress Type=`"System.String`" /><EmailSuccessTemplateFilePath Type=`"System.String`" /><EmailFailureTemplateFilePath Type=`"System.String`" /><EmailSubject Type=`"System.String`" /><SendEmail Type=`"System.Boolean`">False</SendEmail><Transformers Type=`"Metalogix.Transformers.TransformerCollection`"><TransformerCollection /></Transformers></TargetSubSiteOptions><MigratePermissionsForSubSite Type=`"System.Boolean`">False</MigratePermissionsForSubSite><TargetSubSiteTemplateOptions Type=`"Metalogix.File.Actions.TargetLocationOptions`"><PathSource Type=`"Metalogix.File.Actions.TargetLocationOptions+LocationProvider`">TextValue</PathSource><SourceStructureLocation Type=`"Metalogix.File.Actions.TargetLocationOptions+StructureLocation`">Leaf</SourceStructureLocation><ColumnName Type=`"System.String`" /><TextValue Type=`"System.String`">STS#1</TextValue><EmailServer Type=`"System.String`" /><EmailUserName Type=`"System.String`" /><EmailPassword Type=`"System.String`" /><ToEmailAddress Type=`"System.String`" /><FromEmailAddress Type=`"System.String`" /><CCEmailAddress Type=`"System.String`" /><BCCEmailAddress Type=`"System.String`" /><EmailSuccessTemplateFilePath Type=`"System.String`" /><EmailFailureTemplateFilePath Type=`"System.String`" /><EmailSubject Type=`"System.String`" /><SendEmail Type=`"System.Boolean`">False</SendEmail><Transformers Type=`"Metalogix.Transformers.TransformerCollection`"><TransformerCollection /></Transformers></TargetSubSiteTemplateOptions><UseAzureOffice365Upload Type=`"System.Boolean`">True</UseAzureOffice365Upload><EncryptAzureMigrationJobs Type=`"System.Boolean`">True</EncryptAzureMigrationJobs><EmailServer Type=`"System.String`" /><EmailUserName Type=`"System.String`" /><EmailPassword Type=`"System.String`" /><ToEmailAddress Type=`"System.String`" /><FromEmailAddress Type=`"System.String`" /><CCEmailAddress Type=`"System.String`" /><BCCEmailAddress Type=`"System.String`" /><EmailSuccessTemplateFilePath Type=`"System.String`" /><EmailFailureTemplateFilePath Type=`"System.String`" /><EmailSubject Type=`"System.String`" /><SendEmail Type=`"System.Boolean`">False</SendEmail><Transformers Type=`"Metalogix.Transformers.TransformerCollection`"><TransformerCollection /></Transformers></TargetHierarchyOptions><LoggingOptions Type=`"Metalogix.File.Actions.LoggingOptions`"><LoggingOptions Detail=`"Verbose`" ShowDateWarnings=`"True`" /></LoggingOptions><FilterExpression Type=`"Metalogix.Data.Filters.FilterExpressionList`"><Or IsImplicitGroup=`"True`"><And IsImplicitGroup=`"True`"><FilterExpression><GreaterThan Property=`"CreateDate`" CaseSensitive=`"False`" BaseFilter=`"False`" Pattern=`"01/01/0001 00:00:00`"><AppliesToTypes><Type>Metalogix.File.DirectoryNode</Type></AppliesToTypes></GreaterThan></FilterExpression></And><And IsImplicitGroup=`"True`"><And IsImplicitGroup=`"True`" /></And></Or></FilterExpression><EmailServer Type=`"System.String`" /><EmailUserName Type=`"System.String`" /><EmailPassword Type=`"System.String`" /><ToEmailAddress Type=`"System.String`" /><FromEmailAddress Type=`"System.String`" /><CCEmailAddress Type=`"System.String`" /><BCCEmailAddress Type=`"System.String`" /><EmailSuccessTemplateFilePath Type=`"System.String`" /><EmailFailureTemplateFilePath Type=`"System.String`" /><EmailSubject Type=`"System.String`" /><SendEmail Type=`"System.Boolean`">False</SendEmail><Transformers Type=`"Metalogix.Transformers.TransformerCollection`"><TransformerCollection /></Transformers></ActionOptions>" ) -StoragePointOptions ( New-MetalogixSerializableObject "Metalogix.File.Actions.StoragePointLibrarianOptions" "Metalogix.File" "<ActionOptions Type=`"Metalogix.File.Actions.StoragePointLibrarianOptions, Metalogix.File, Version=8.2.0.2, Culture=neutral, PublicKeyToken=3b240fac3e39fc03`"><StandardStoragePointOptions Type=`"Metalogix.SharePoint.Options.Migration.StoragePointOptions`"><SideLoadDocuments Type=`"System.Boolean`">True</SideLoadDocuments><EmailServer Type=`"System.String`" /><EmailUserName Type=`"System.String`" /><EmailPassword Type=`"System.String`" /><ToEmailAddress Type=`"System.String`" /><FromEmailAddress Type=`"System.String`" /><CCEmailAddress Type=`"System.String`" /><BCCEmailAddress Type=`"System.String`" /><EmailSuccessTemplateFilePath Type=`"System.String`" /><EmailFailureTemplateFilePath Type=`"System.String`" /><EmailSubject Type=`"System.String`" /><SendEmail Type=`"System.Boolean`">False</SendEmail><Transformers Type=`"Metalogix.Transformers.TransformerCollection`"><TransformerCollection /></Transformers></StandardStoragePointOptions><CreateFileShareEndpoints Type=`"System.Boolean`">False</CreateFileShareEndpoints><EmailServer Type=`"System.String`" /><EmailUserName Type=`"System.String`" /><EmailPassword Type=`"System.String`" /><ToEmailAddress Type=`"System.String`" /><FromEmailAddress Type=`"System.String`" /><CCEmailAddress Type=`"System.String`" /><BCCEmailAddress Type=`"System.String`" /><EmailSuccessTemplateFilePath Type=`"System.String`" /><EmailFailureTemplateFilePath Type=`"System.String`" /><EmailSubject Type=`"System.String`" /><SendEmail Type=`"System.Boolean`">False</SendEmail><Transformers Type=`"Metalogix.Transformers.TransformerCollection`"><TransformerCollection /></Transformers></ActionOptions>" ) -FilterExpression ( New-MetalogixSerializableObject "Metalogix.Data.Filters.FilterExpressionList" "Metalogix.Actions" "<Or IsImplicitGroup=`"True`"><And IsImplicitGroup=`"True`"><FilterExpression><GreaterThan Property=`"CreateDate`" CaseSensitive=`"False`" BaseFilter=`"False`" Pattern=`"01/01/0001 00:00:00`"><AppliesToTypes><Type>Metalogix.File.DirectoryNode</Type></AppliesToTypes></GreaterThan></FilterExpression></And><And IsImplicitGroup=`"True`"><And IsImplicitGroup=`"True`" /></And></Or>" ) -CorrectName -CorrectNameCharacter "_" -DefaultContentType -ContentTypeID "" -ContentTypeFieldMappings ( New-MetalogixSerializableObject "Metalogix.File.Actions.ContentTypeFieldMappings" "Metalogix.File" "<XmlableSet />" -Enumerate) -Transformers ( New-MetalogixSerializableObject "Metalogix.Transformers.TransformerCollection" "Metalogix.Actions" "<TransformerCollection />" -Enumerate) -jobfile "C:\Users\arikf\AppData\Roaming\Metalogix\Content Matrix Console - File Share Edition\JobHistory.lst"
}
